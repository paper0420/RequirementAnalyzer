<a href='D:\Code_Projects\RequirementAnalyzer\RequirementAnalyzer.App\Output\Index.html'>Home</a><h1>SYR_CCS_606</h1></br><li>1.1.31.20 SYR_CCS_606: Installation of V2G Root Certificate for Plug-and-Charge functionality</br></li><li>1.1.31.20.1 Description</br></li><li>1.1.31.20.1.0-1 Brief description:
Each CCU shall contain V2G root certificates (max. 5).
These are globally valid (top level) root certificates of the PKI (Public Key Infrastructure). They are used to check the authenticity of certificates. </br></li><li>1.1.31.20.1.0-2 Preconditions: 
Sessions - DEFAULT_SESSION APP, EXTENDED_DIAGNOSTIC_SESSION APP
Secure ECU Mode - Field, Plant and Engineering

V2G session is not on-going.</br></li><li>1.1.31.20.1.0-3 Trigger: Diagnostic Routine is executed "STEUERN_PNC_ROOT_ZERTIFIKAT_SCHREIBEN 0x31 0x01 0xA3AE"</br></li><li>1.1.31.20.1.0-4 Input data: 
Diagnostic Routine Request (Zedis v30 integration) and CAN PDUs for Plug and Charge (NK integration)
Ref:
https://asc-repo.bmwgroup.net/svn/asc271/Projects/CCUP_BEV21/branches/CCUBEV21_2143/BMW/Doc/NK/NK_SP2021_21KW37_V92_AE_CAN_FD_V98.pdf

Update in Meta.2223
ZEDISv34
NK17 integration 
https://asc-prod-ha-wig.bmw.com/svn/asc271/Projects/CCUP_BEV21/branches/CCUBEV21_2219/BMW/Doc/NK/NK_SP2021_22KW17_V101_AE_CAN_FD_V107.pdf
</br></li><li>1.1.31.20.1.0-5 Description of behaviour:
Installation of V2G root certificate shall be triggered by Diagnostic Routine. In Zedisv30, structure of the request is defined as below. 
 

***
Update Meta.2223 (EPIC 30877)
in Zedis v34, new parameter "Finger print length" is added to the diag request. Since fingerprint length can be less than or equal to 32 bytes, fingerprint length is needed to fetch the actual fingerprint w/o padding. Also, this length parameter along woth fingerprint to be part of hash calculation while performing certificate validation. 

 

Additonally, in NK17, PlugAndChargeCertificateACKRes is modified. Change is explained in the PPT.  
https://ccu-svn.microfuzzy.com/CCU_G26/SP21/SP21_SOP_2207/ENG.02_SystemRequirementsAnalysis/ENG.02_SystemRequirementSpecification/AdditionalDocuments/Charging_Interface/CCS/PnC/MF_Concept_Plug&Charge_CCU-31907_CCU-30877.pptx

***

When the job (startRoutine) is executed, CCU SW shall trigger the internal calls (for example, calling an API) to process the received request data and depending on acceptance of the request, CCU immediately provides the response (positive or negative) back to tester/MGU. 

when the installation is started, CCU should send "PlugAndChargeCertificateChange" PDU over CAN with signal StatusInstallationRootCertificatePlugAndCharge set to 1h. Refer CCU-31103 PPT (NK09) for above PDU "PlugAndChargeCertificateChange":
https://ccu-svn.microfuzzy.com/CCU_G26/SP21/SP21_SOP_2207/ENG.02_SystemRequirementsAnalysis/ENG.02_SystemRequirementSpecification/AdditionalDocuments/Charging_Interface/CCS/PnC/Plug&Charge_CCU-31103.pptx
 
Once accepted, request data is being processed and validated, and then cert. installation happens.

******EPIC CCU-31907 change
Additionally, when the installation has started (PlugAndChargeCertificateChange PDU is sent out with 1h now), timer shall be started immediately internally in BSW. Timeout value is currently defined as 10 sec and should be calibratable. 
If installation does not finish within 10 seconds and timeout happens then installation process shall be aborted and PlugAndChargeCertificateACKRes shall be sent out with value Ah.
https://ccu-svn.microfuzzy.com/CCU_G26/SP21/SP21_SOP_2207/ENG.02_SystemRequirementsAnalysis/ENG.02_SystemRequirementSpecification/AdditionalDocuments/Charging_Interface/CCS/PnC/MF_Concept_Plug&Charge_CCU-31907_CCU-30877.pptx
*******

CCU SW shall perform set of validations before storing certificate into NVM.

1) if the "Common Name", present in the Intermediate Signing-CA certificate's "Subject" field as below, contains the matching data string "PlugAndCharge-CCU-Root-Signing-"
Defined subject: Certificate Subject: cn=PlugAndCharge-CCU-Root-Signing-1,st=Production,ou=VehiclePKI-SigningService,o=BMW Group,c=DE

2) To ensure at CCU that the received V2G root certificate is not changed, a message payload (as in step a below) is signed by intermediate-signing CA. The ECDSA signature is created and sent in same diag routine request. CCU SW shall verify this ECDSA signature using SHA-512 hashing, given the message payload, the signer's EC public key and the signature received. Sub-steps are below:
  	a) Calculate hash over payload with SHA-512 (this payload includes Fingerprint (ZERTIFIKAT_FINGERPRINT) Fingerprint length (ZERTIFIKAT_FINGERPRINT_LAENGE), Fingerprint (ZERTIFIKAT_FINGERPRINT), Certificate Length (ZERTIFIKAT_LAENGE_WERT), V2G root certificate (ZERTIFIKAT_DATA_1 to ZERTIFIKAT_DATA_4), Signature Type (SIGNATUR_TYP)) such that this hash (H1) value is the message payload to perform a ECDSA signature verification for.
	
 	 b) Execute ECDSA Signature verification with following parameters:
	     i) Message Payload / Data to sign : H1 from step a.
                ii) Signature to be verified ("SIGNATUR" in the diag request)
                iii) Actual size of the signature shall match to the length provided in diag request ("SIGNATUR_LAENGE"). 
                 iv) Public Key to be used for signature verification: Intermediate CA public key.
                 v) ECDSA with secp384r1 curve and SHA512. For 384-bit EC, ECDSA signature is 96 bytes.
         
3) CCU SW shall validate the certificate chain. It shall validate if intermediate signing-CA certificate (SIGNATUR_ZERTIFIKAT_DATA_1 to 4) traces back to a BMW signing-CA certificate. 

4) CCU SW shall validate the certificate size (if certificate size can fit into configured NVM block and if certificate size matches to the length provided in the diag req.)

Once the validation is successful, CCU SW shall store the certificate in defined NVM block and the fingerprint into NVM. CCU SW shall be able to manitain the mapping between stored V2G root certificate, its slot index and correspondng Fingerprint. 

Stored root certificate shall not be replaced by a bootloader or RSU Update (i.e. after flashing SW). 

When the installation is finished (Certificate is stored successfully or validation failed or NVM/memory not available issue or any other error), CCU SW shall immediately trigger the "PlugAndChargeCertificateACKRes" PDU over CAN FD . Below table shows the value set for PDU signals.

Refer PPT for change on PDU (ACKRes):
https://ccu-svn.microfuzzy.com/CCU_G26/SP21/SP21_SOP_2207/ENG.02_SystemRequirementsAnalysis/ENG.02_SystemRequirementSpecification/AdditionalDocuments/Charging_Interface/CCS/PnC/MF_Concept_Plug&Charge_CCU-31907_CCU-30877.pptx

InstalledCertificateTypePlugAndCharge
	0h: V2G_Root_Zertifikat
CertificateInstallationStatusPlugAndCharge
	0h: Vorgang_erfolgreich_abgeschlossen
Or 
Error Codes as defined in NK17.

https://ccu-svn.microfuzzy.com/CCU_G26/SP21/SP21_SOP_2207/ENG.02_SystemRequirementsAnalysis/ENG.02_SystemRequirementSpecification/AdditionalDocuments/Charging_Interface/CCS/PnC/PnC_ACKRes&AUTH_PDU_ErrorCodes_v2.xlsx
InstalledCertificateSlotNumberPlugAndCharge
	1h â€“ Ah (depending on used slot while installation)
InstalledCertificateIdentifierPlugAndCharge
InstalledCertificateEmaidPlugAndCharge	NA
InstalledCertificateFingerprintPlugAndCharge	Fingerprint value in total 32 signals (each signal of 10 bit has 8 bit for Fingerprint and 2 bit for Qualifier)
InstalledCertificateIdentifierLengthPlugAndCharge	Length of Fingerprint or EMAID
This should be same as in diag request data.
</br></li><li>1.1.31.20.1.0-6 Timing Requirements: NA in Meta.2145</br></li><li>1.1.31.20.1.0-7 Output data: 
V2G root certificate and corresponding Fingerprint shall be stored in NVM.
Transmission of PDU ("PlugAndChargeCertificateACKRes") on CANFD to MGU once the installation is finished (either failed or successful).</br></li><li>1.1.31.20.1.0-8 Postconditions: 
CCU shall establish TLS connection with EVSE (provided EVSE has the SECC cert chain which is traceable upto installed V2G root).
CCU shall be able to validate SAProvisioning Cert Chain (from CPS) received in CertificateInstallationRes (provided SA prov. chain shall be traceable upto installed V2G root and CCU stores OEM prov. root cert & key).</br></li><li>1.1.31.20.1.0-9 Descriptions of exceptions: 
V2G root certificate content is not validated.</br></li><li>1.1.31.20.1.0-10 Dependencies and interactions:
vSCC, SCCAdaptor, Diag, ECUconfig, BAC Crypto, NVM, RTE, CAN FD stack, Pana_SWC_Security</br></li><li>1.1.31.20.2 Differences to CRS</br></li><li>1.1.31.20.2.0-1 NA</br></li><li>1.1.31.20.3 Questions and Answers</br></li><li>1.1.31.20.3.0-1 NA</br></li>