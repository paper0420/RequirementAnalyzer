<a href='D:\Code_Projects\RequirementAnalyzer\RequirementAnalyzer.App\Output\Index.html'>Home</a><h1>SYR_CCS_607</h1></br><li>1.1.31.21 SYR_CCS_607: Deletion of V2G Root Certificate and Contract Certificate (with assocuated private key) for Plug-and-Charge functionality</br></li><li>1.1.31.21.1 Description</br></li><li>1.1.31.21.1.0-1 Brief description:
Each CCU shall contain V2G root certificates (max. 5) and Contract certificates with each having associated private keys (max. 4). 
Tester or MGU can trigger the deletion of stored certificate (& associated key) from CCU via Diagnostic routine or via control signal in CAN PDU.</br></li><li>1.1.31.21.1.0-2 Preconditions: 
CCU is running but no V2G charging session is active. 
i.e. FunctionControl is not ChargingMode (BMW_opm_SpChaCtlCcsInt interface) and SCC StateMachineStatus is 0 or 1 (BMW_st_StMacCcsInt interface).

Additionally, below conditions are applicable for routines only,
Sessions - DEFAULT_SESSION APP, EXTENDED_DIAGNOSTIC_SESSION APP
Secure ECU Mode - Engineering</br></li><li>1.1.31.21.1.0-3 Trigger: 
Diagnostic Routine is executed for deletion: "STEUERN_PNC_ROOT_ZERTIFIKAT_LOESCHEN 0x31 0x01 0xA3AD"
Or, "STEUERN_PNC_CONTRACT_ZERTIFIKAT_LOESCHEN 0x31 0x01 0xA3AB"

CAN PDU "PlugAndChargeControl"is received from MGU for deletion where:
Signal DeleteV2GRootCertificatePlugAndCharge is set
Or, Signal DeleteContractCertificatePlugAndCharge is set</br></li><li>1.1.31.21.1.0-4 Input data: Diagnostic Routine Request (Zedis v30 integration) and CAN PDUs for Plug and Charge (NK integration)
Ref:
https://asc-repo.bmwgroup.net/svn/asc271/Projects/CCUP_BEV21/branches/CCUBEV21_2143/BMW/Doc/NK/NK_SP2021_21KW37_V92_AE_CAN_FD_V98.pdf</br></li><li>1.1.31.21.1.0-5 Description of behaviour:
In CCU SW, for each stored certificate (whether its V2G root or contract cert), a unique slot index is defined and maintained in SW. Each slot index is mapped to NVM block reference.

When deletion is triggered via diag routine or via CAN PDU signal, CCU SW will receive a slot index value. If routine is executed and not yet finished, CCU SW shall provide response back as "pending" to tester/MGU.

If slot index is greater than 0 (range from 1 to 10), one stored certificate of specific cert. type (certificate type means V2G root cert or Contract cert) shall be deleted. 
If slot index is 0, all stored certificates of cert. type shall be deleted sequentially.
CCU SW shall be able to parse and find valid slot index (or all indexes) where cert. of particular certificate type is stored. 

Depending on cert. type, CCU SW shall pass slot index to internal SW API (Scc_DeleteContract or Scc_DeleteRootCert). Certificates are stored in NVM therefore when deletion is performed, API invalidates the associated NVM block status (Scc_NvMBlockReadState_Invalidated). 
The associated private keys (only for contract certs.) are stored in HSM. API injects zeros (00) for the associated contract private key via CSM jobs.

If deletion is successful, slot index become empty and only new installation can be performed at that slot index. 

CCU SW shall provide response for the routine as "positive". 
If deletion fails when performed via diag routine, "negative" response shall be provided.
There is no response provided when deletion is performed via CAN signal. 

Additionally, CCU SW shall delete additional data stored in NVM for corresponding slot index related to PlugAndChargeCertificateStatus PDU signals (such as fingerprint for V2G root cert, certificate error counter etc.)

Note:
If "GetCertificateStorageStatusPlugAndCharge" status signal and control signal (such as DeleteV2GRootCertificatePlugAndCharge, DeleteContractCertificatePlugAndCharge, SelectContractCertificatePlugAndCharge) are set together in same PDU "PlugAndChargeControl", It may happen that updated cert status for slots may not reflect in immediate status PDU (there is no strict requirement). If need to have the updated slot status, status PDU can be requested again.</br></li><li>1.1.31.21.1.0-6 Timing Requirements: NA</br></li><li>1.1.31.21.1.0-7 Output data: 
NA</br></li><li>1.1.31.21.1.0-8 Postconditions: 
If read certificate status via PlugAndChargeCertificateStatus is performed after deletion, the PDU having the matching cert. type (StoredCertificateType) and relevant slot index (StoredCertificateSlotNumber) shall reflect "StoredCertificateStatusPlugAndCharge" as "4h: Speicher_Slot_nicht_belegt" and "StoredCertificateIdentifier" as 0. 

Also, reinstallation of new certificate shall be possible via diag routine (for both V2G root and Contract Cert.) at same empty slot (considering all other slots are occupied).

During V2G session and having one empty slot in CCU (where deletion is performed),
When V2G root Cert was deleted:
1. TLS setup would fail when SECC cert. chain cannot be validated upto V2G root since the only matching V2G root cert. is already deleted.
When Contract Cert. chain & key was deleted:
2. Certification Installation via PLC can be requested during V2G session.</br></li><li>1.1.31.21.1.0-9 Descriptions of exceptions: 
Since only 9 certificates are to be installted in CCU in Meta.2145
5 V2G roots : slot index value can vary from 1 to 5
4 Contract cert : slot index value can vary from 1 to 4
</br></li><li>1.1.31.21.1.0-10 Dependencies and interactions:
vSCC, SCCAdaptor, Diag, ECUconfig, CSM, Crypto, HSM, NVM</br></li><li>1.1.31.21.2 Differences to CRS</br></li><li>1.1.31.21.2.0-1 NA</br></li><li>1.1.31.21.3 Questions and Answers</br></li><li>1.1.31.21.3.0-1 NA</br></li>