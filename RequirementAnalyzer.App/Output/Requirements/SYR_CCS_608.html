<a href='D:\Code_Projects\RequirementAnalyzer\RequirementAnalyzer.App\Output\Index.html'>Home</a><h1>SYR_CCS_608</h1></br><li>1.1.31.22 SYR_CCS_608: Handling for Plug-and-Charge CAN-FD PDUs and SW Interfaces</br></li><li>1.1.31.22.1 Description</br></li><li>1.1.31.22.1.0-1 Brief description:
New CAN PDUs are defined in CCU for example, to control the plug and charge functionality from Backend/MGU (such as PnC activation, slot selection, deletion of certificate and get certificates status) and to provide response/status from CCU (such as status on installation, status on each stored certifiacte, status on authentication etc..)
Handling for such CAN PDUs shall be done in CCU SW.

This SYR also discuss about few interfaces and global variable state implemented in CCU BSW to control the plug and chargre behavior such as indication to BMW appl. to skip charging via plug&charge and indication to BMW appl. for setting the relevant network state / comnet for receiving Uhrezeit Datum PDU.</br></li><li>1.1.31.22.1.0-2 Preconditions: 
CCU is awake and running. 
Additionally, V2G charging session shall not be on-going when processing signals in CCU SW (i.e. Deletion of Cert., Selection of Cert. Slot, Activate of PnC) in RX PDU "PlugAndChargeControl".</br></li><li>1.1.31.22.1.0-3 Trigger: 
Trigger of TX PDU:
PDU: PlugAndChargeCertificateStatus (Change : CCU-31907)
Event: Receipt of the signal GetCertificateStorageStatusPlugAndCharge in Control PDU PlugAndChargeControl.

PDU: PlugAndChargeCertificateACKRes (Change: CCU-31907)
Event: Installation of a certificate is completed or aborted due to failure

PDU: PlugAndChargeStatusAuthentication
Event: After attempting Plug and Charge Authentication or if session is aborted before Authentication

PDU: PlugAndChargeContractInstallation 
Event: Installation of a new contract certificate is started.

PDU: Status SCharge
Event: Periodic PDU transmission

PDU: PlugAndChargeCertificateChange
Event: Installation of a new certificate (V2G Root/Contract) is started OR Deletion of certificate is finished

SkipPlugAndCharge (Change : CCU-31907)
Global Var. maintained in BSW

BMW_b_ComNetReqPlgdChaAcv 
Indication to BMW appl. for setting the required vehicle  network state (comnet) in order to recieve the uhrzeit datum pdu in CCU</br></li><li>1.1.31.22.1.0-4 Input data:  NK integration
Ref (until Meta.2209):
https://asc-repo.bmwgroup.net/svn/asc271/Projects/CCUP_BEV21/branches/CCUBEV21_2143/BMW/Doc/NK/NK_SP2021_21KW37_V92_AE_CAN_FD_V98.pdf

Ref (from Sprint 2211, CCU-31103):
New NK : 
https://asc-repo.bmwgroup.net/svn/asc271/Projects/CCUP_BEV21/branches/CCUBEV21_2211/BMW/Doc/NK/NK_SP2021_22KW09_V98_AE_CAN_FD_V104.pdf

Ref (sprint 2219, epic CCU-31907)
New NK:
https://asc-prod-ha-wig.bmw.com/svn/asc271/Projects/CCUP_BEV21/branches/CCUBEV21_2219/BMW/Doc/NK/NK_SP2021_22KW17_V101_AE_CAN_FD_V107.pdf</br></li><li>1.1.31.22.1.0-5 Description of behaviour:
This SYR is defining the scope covered (in Meta. 2145).
Refer Doc at SVN:
https://ccu-svn.microfuzzy.com/CCU_G26/SP21/SP21_SOP_2207/ENG.02_SystemRequirementsAnalysis/ENG.02_SystemRequirementSpecification/AdditionalDocuments/Charging_Interface/CCS/PnC/PlugCharge_SWArchitecture_Gen5_V6.pptx

***************
Change in CCU-31103: Refer below (starting from Meta 2217 A sprint):
Reflecting main change points from SW perspective in Change-Doc below:
https://ccu-svn.microfuzzy.com/CCU_G26/SP21/SP21_SOP_2207/ENG.02_SystemRequirementsAnalysis/ENG.02_SystemRequirementSpecification/AdditionalDocuments/Charging_Interface/CCS/PnC/Plug&Charge_CCU-31103.pptx
https://ccu-svn.microfuzzy.com/CCU_G26/SP21/SP21_SOP_2207/ENG.02_SystemRequirementsAnalysis/ENG.02_SystemRequirementSpecification/AdditionalDocuments/Charging_Interface/CCS/PnC/PnC_ACKRes&AUTH_PDU_ErrorCodes_v2.xlsx

From Customer:
https://ccu-svn.microfuzzy.com/CCU_G26/SP21/SP21_SOP_2207/ENG.02_SystemRequirementsAnalysis/ENG.02_SystemRequirementSpecification/AdditionalDocuments/Charging_Interface/CCS/PnC/Plug&Charge_Concept_V07.pptx
****************

***************
Change in CCU-31907: Refer below (starting from Meta 2225 A sprint):
Reflecting main change points from SW perspective in Change-Doc-meta2225 below:
https://ccu-svn.microfuzzy.com/CCU_G26/SP21/SP21_SOP_2207/ENG.02_SystemRequirementsAnalysis/ENG.02_SystemRequirementSpecification/AdditionalDocuments/Charging_Interface/CCS/PnC/MF_Concept_Plug&Charge_CCU-31907_CCU-30877.pptx
***************

1. CCU will receive control CAN-FD PDU "PlugAndChargeControl" from MGU. Based on the signals value, CCU shall perform actions or provide response back to MGU via CAN-FD.
Note: In "PlugAndChargeControl" PDU, SkipPlugAndCharge signal is not expected to be set by MGU. There should not be any reaction from BSW for this input signal. 
Refer point 5 below to understand how SkipPlugAndCharge is handled n BSW. 

a. If "GetCertificateStorageStatusPlugAndCharge" signal is set, CCU shall provide status on all configured certificate slots (storing the certificate or free slot) to MGU. CCU shall send "PlugAndChargeCertificateStatus" MUX PDU corresponding to each slot. In current SW, CCU is storing 9 certificates in NVM (4 contract cert. and 5 V2G root cert.), therefore 9 MUX PDUs shall be triggered. 
Refer Change-Doc for "StoredCertificateStatusPlugAndCharge" change in BSW.

Refer Change-Doc-meta2225 for "StoredCertificateEmaidPlugAndCharge", "StoredCertificateFingerprintPlugAndCharge" and "StoredCertificateIdentifierLengthPlugAndCharge" adaptations in BSW. Default value for signal StoredCertificateEmaidPlugAndCharge shall be FFFFFFFF h, for signal StoredCertificateFingerprintPlugAndCharge shall be 3FF h and for signal  StoredCertificateIdentifierLengthPlugAndCharge shall be 3F h.

 
b. If DeleteV2GRootCertificatePlugAndCharge or DeleteContractCertificatePlugAndCharge is set, CCU SW shall perform deletion of either all certificates or just one certificate depending on signal value. This is handled in SYR_CCS_607. Once the certificate of any type (V2G root or contract) is deleted, CCU shall send PDU "PlugAndChargeCertificateChange" with respective-type signal "StatusDeleteContractCertificatePlugAndCharge" (for contract cert.) or with signal "StatusDeleteV2GRootCertificatePlugAndCharge" (for V2G root) value set to "1h:  deleted successfully".
Note: If Backend triggers delete cert. Job or MGU sends PlugAndChargeControl PDU with DeleteV2GRootCertificatePlugAndCharge or DeleteContractCertificatePlugAndCharge as “0” (which means delete all stored certificates). PlugAndChargeCertificateChange PDU shall be sent with 
StatusDeleteV2GRootCertificatePlugAndCharge or StatusDeleteContractCertificatePlugAndCharge if deletion is successful (value 1h, all certificates deleted) or deletion is aborted (value 0h, not all certificates are deleted). MGU can verify the slot status by requesting PlugAndChargeCertificateStatus PDU and retrigger the deletion for failed slots (where certificate still present).
Refer Change-Doc for "PlugAndChargeCertificateChange" change in BSW.

When deletion is requested via MGU and V2G session is not on-going, timer shall be started internally. If timeout (10 second) happens and deletion process is not yet finished which means PlugAndChargeCertificateChange is not sent yet then deletion process shall be aborted and PlugAndChargeCertificateChange PDU shall be sent with signal value (StatusDeleteContractCertificatePlugAndCharge Or StatusDeleteV2GRootCertificatePlugAndCharge) “0h”. Refer Change-Doc-meta2225.

   

 
c. If SelectContractCertificatePlugAndCharge is set (but not 0), CCU SW shall choose contract certificate slot index as signal value. 
If signal SelectContractCertificatePlugAndCharge is set to 0 (in this case MGU needs contract installation via PLC), CCU SW shall choose next available empty slot index.
Slot index value shall be stored in NVM.

d. If SetActivationStatusPlugAndCharge is set, CCU SW shall request to procced via TLS or TCP connection with EVSE depending on the value. Activation status value to be stored in NVM.

It is mandatory to have activation status set to be 1 together with slot selection at least for first PnC V2G session. Later in next sessions, if CCU does not receive control PDU from MGU and FunctionControl is set to ChargingMode, CCU SW shall apply values from NVM to proceed with new PnC V2G session.

****************
2. Backend/MGU can trigger certificate installation (V2G root or Contract Cert.) via diag routine or can request installation via PLC (only Contract Cert.) on free slot index,
As soon as installation is started, CCU shall send PDU "PlugAndChargeContractInstallation" "PlugAndChargeCertificateChange" with respective signal "StatusInstallationContractCertificatePlugAndCharge" (for contract cert.) or with signal "StatusInstallationRootCertificatePlugAndCharge" (for V2G root) value set to "1h:  Neue_Zertifikate_werden_installiert".
When certification installation (both V2G root and Contract Cert.) is finished either with success or error, CCU shall send PDU "PlugAndChargeCertificateACKRes" with installation status (set to 0 : Process Completed Successfully or with one of the error codes - range 1h to ch) and with all other PDU signals. 
Refer Change-Doc for Error codes reference.
Refer Change-Doc-meta2225 for "InstalledCertificateEmaidPlugAndCharge", "InstalledCertificateFingerprintPlugAndCharge", "InstalledCertificateIdentifierLengthPlugAndCharge" and "CertificateInstallationStatusPlugAndCharge" adaptations in BSW.  Default value for signal InstalledCertificateEmaidPlugAndCharge shall be FFFFFFFF h, for signal InstalledCertificateFingerprintPlugAndCharge shall be 3FF h and for signal  InstalledCertificateIdentifierLengthPlugAndCharge shall be 3F h.


****************
3. When, in control PDU, activation status is set to 1 and contract cert. slot selection is done, CCU SW shall proceed with PnC V2G session. In case if CCU has successful AuthorizationReq-Resp with EVSE, CCU shall send "PlugAndChargeStatusAuthentication" PDU with authentication status set to 0: Authentifizierung_Erfolgerich and with slot id. However, it could happen that charging is aborted due to some failure (like failure in  TLS conn., High-level communication, NVM, XMLSecurity, Contract. cert installation or update etc.) and never reaches successful authorization, then CCU SW shall send 
""PlugAndChargeStatusAuthentication" PDU with authentication status mapped to error codes - range 1h to 8h) and with all other PDU signals. 
In this PDU, new signal - StatusUnavailabilityPlugAndCharge is added. This signal shall be set to 1h as soon as authorization fails. 
Refer change-Doc for Error codes reference and StatusUnavailabilityPlugAndCharge signals.

****************

4. CCU is transmitting "Status SCharge Aktivierung" PDU (where Status SCharge is a MUX PDU) with a cycle time of 1sec. In this PDU, two new signals "SelectedContractCertificatePlugAndCharge" and "ActivationStatusPlugAndCharge" are added which shall be set according to control PDU "PlugAndChargeControl" signals i.e.  "SelectContractCertificatePlugAndCharge" and "SetActivationStatusPlugAndCharge".
When CCU wakeup, "Status SCharge Aktivierung" PDU is immediately updated with previous values (in case the control PDU "PlugAndChargeControl" is not received before charging session, previous values will be retained) and when "PlugAndChargeControl" PDU is receieved in power cycle, "Status SCharge Aktivierung" PDU shall be updated with received values.

***************************
5. SkipPlugAndCharge Mechanism  
BSW should define SkipPlugAndCharge as global variable. 
BSW should implement one local counter variable and one retry counter variable (calibratable).
Local counter should be incremented by 1 whenever PnC (AC/DC) V2G high-level communication is aborted or failed due to below scenarios.
PaymentDetails_Failed,
CertificateInstallation_Failed,
CertificateUpdate_Failed,
Authorization_Failed
TLS_Failed
If local counter variables matches retry counter variable value, set SkipPlugAndCharge var. to 1. When SkipPlugAndCharge is set to 1, if PnC activation request is recieved via Control PDU from MGU, charging shall not be possible until it is reset.
Local counter and SkipPlugAndCharge should be reset to 0 when vehicle state (ST_CON_VEH) is set as "Fahrbereitschaft_Herstellen".
SkipPlugAndCharge var. and Local counter are not retained if CCU sleep-wakeup happens. Info: Impact may be SkipPlugAndCharge would take longer than expected.  

*************************
6. SW interface BMW_b_ComNetReqPlgdChaAcv
This interface should be implemented in BSW. 
It should be set to 1 when BMW_st_RqrtAcvnComCcs interface (Info: this interface is already defined to trigger SLAC procedure after PLC bootup between CCU and EVSE, refer SYR_PLC_15) is set to 0x01 (Start SLAC with blank NMK) or 0x02 (Start PLC link with last NMK) by BMW Appl. SW.

It should be reset to 0 when BMW_st_ActAvlComCcs (Info: this interface is already defined to provide SLAC status from CCU BSW to CCU BMW appl. SW, refer SYR_PLC_15) is set 0x02 (SLAC link matched and joined) or BMW_st_RqrtAcvnComCcs is set to 0x00 (no SLAC required). 

Note: On BMW Appl. SW, based on BMW_b_ComNetReqPlgdChaAcv value "1", Appl. will set ComNetReq to 1 (Infrastructure) to ensure that Kombi ECU is awake and UhrZeit_Datum PDU is received over CAN FD which is required for certificate validity (example in TLS). 

******************************

Update ref. ERR#103733
Certificate installation job shall not be started if pre-condition checks are failed, namely length or format mismatch. In such case CCU shall not send PDU "PlugAndChargeCertificateACKRes".</br></li><li>1.1.31.22.1.0-6 Timing Requirements: As per NK.</br></li><li>1.1.31.22.1.0-7 Output data: 
1. ISO 15118-2 PnC DC/-AC charging session is perfomed.
a) with selecting one of the stored contract cert. and setting activation status via control PDU.
b) with request for new cert. installation via PLC on free slot and setting activation status via control PDU. 
c) with stored values from NVM when no control PDU is sent from MGU.

2. Transmission of TX-PDUs (depending on event) from CCU on CAN FD to MGU.</br></li><li>1.1.31.22.1.0-8 Postconditions: 
NA</br></li><li>1.1.31.22.1.0-9 Descriptions of exceptions: 
Since remaining validity calc. cannot be done correctly due to vector SW limitation. Only limited scope is implemented in 2145. Proper format and right calculated value of remaning val. shall be out of scope in 2145.</br></li><li>1.1.31.22.1.0-10 Dependencies and interactions:
vSCC, SCCAdaptor, Diag, Diag App, CSM, Crypto, HSM, NVM, CANFD, COM stack</br></li><li>1.1.31.22.2 Differences to CRS</br></li><li>1.1.31.22.2.0-1 NA</br></li><li>1.1.31.22.3 Questions and Answers</br></li><li>1.1.31.22.3.0-1 NA</br></li>